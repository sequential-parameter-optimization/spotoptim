# SPDX-FileCopyrightText: 2026 bartzbeielstein
#
# SPDX-License-Identifier: AGPL-3.0-or-later
#
# =============================================================================
# .github/workflows/docs.yml  —  Documentation Build & Deploy
# =============================================================================
# Pipeline:
#   1. Checkout
#   2. Set up Python + uv
#   3. Install Python dependencies
#   4. Install Quarto CLI (PINNED)
#   5. Generate API reference with quartodoc
#   6. Render Quarto site & publish to gh-pages
# =============================================================================

name: Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - '_quarto.yml'
      - 'src/spotoptim/**'
      - 'pyproject.toml'
  workflow_dispatch:

permissions: read-all

env:
  # ⚠️ Pinned to match production safety standards.
  QUARTO_VERSION: "1.7.29"
  PYTHON_VERSION: "3.13"

jobs:
  deploy-docs:
    name: Build & Deploy Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write   # push access via gh-pages

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history ensures cross-referencing interlinks work safely

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python dependencies
        run: |
          uv sync --group dev
          # This assumes `quartodoc` is inside your pyproject.toml [dev] group

      - name: Install Quarto CLI ${{ env.QUARTO_VERSION }}
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: ${{ env.QUARTO_VERSION }}

      - name: Verify Quarto installation
        run: quarto check

      - name: Generate API reference with quartodoc
        # Rebuild dynamically instead of keeping autogenerated `.qmd` tracked into git
        run: |
          uv run quartodoc build --config _quarto.yml
          uv run quartodoc interlinks

      - name: Render Quarto site
        run: uv run quarto render --no-cache

      - name: Deploy to GitHub Pages
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: gh-pages
          path: _site
          render: "false"   # Handled in prior step
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
