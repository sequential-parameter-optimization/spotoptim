# SPDX-FileCopyrightText: 2026 bartzbeielstein
#
# SPDX-License-Identifier: AGPL-3.0-or-later
#
# =============================================================================
# .github/workflows/docs.yml  —  Documentation Build & Deploy
# =============================================================================
# Pipeline:
#   1. Checkout
#   2. Set up Python + uv
#   3. Install Python dependencies
#   4. Install Quarto CLI (PINNED)
#   5. Generate API reference with quartodoc
#   6. Render Quarto site & publish to gh-pages
# =============================================================================

name: Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - '_quarto.yml'
      - 'src/spotoptim/**'
      - 'pyproject.toml'
  workflow_dispatch:

permissions: read-all

env:
  # ⚠️ Pinned to match production safety standards.
  QUARTO_VERSION: "1.8.27"
  PYTHON_VERSION: "3.13"

jobs:
  deploy-docs:
    name: Build & Deploy Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write   # push access via gh-pages

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2
        with:
          fetch-depth: 0   # Full history ensures cross-referencing interlinks work safely

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.3.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up uv
        uses: astral-sh/setup-uv@e58605a9b6da7c637471fab8847a5e5a6b8df081 # v5.2.2

      - name: Install Python dependencies
        run: |
          uv sync --all-extras --group dev
          # This assumes `quartodoc` is inside your pyproject.toml [dev] or [docs] group

      - name: Install Quarto CLI ${{ env.QUARTO_VERSION }}
        uses: quarto-dev/quarto-actions/setup@8a96df13519ee81fd526f2dfca5962811136661b # v2.1.2
        with:
          version: ${{ env.QUARTO_VERSION }}

      - name: Verify Quarto installation
        run: quarto check

      - name: Generate API reference with quartodoc
        # Rebuild dynamically instead of keeping autogenerated `.qmd` tracked into git
        run: |
          uv run python docs/quartodoc_build.py
          uv run quartodoc interlinks

      - name: Render Quarto site
        run: uv run quarto render --no-cache

      - name: Deploy to GitHub Pages
        uses: quarto-dev/quarto-actions/publish@8a96df13519ee81fd526f2dfca5962811136661b # v2.1.2
        with:
          target: gh-pages
          path: _site
          render: "false"   # Handled in prior step
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
